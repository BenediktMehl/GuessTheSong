name: CodeCharta Analysis

on:
  schedule:
    - cron: '0 3 * * *' # Run daily at 3:00 AM UTC

jobs:
  check-commits:
    name: Check for recent commits on main
    runs-on: ubuntu-latest
    outputs:
      has-commits: ${{ steps.check.outputs.has-commits }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Check for commits in last 24 hours
        id: check
        run: |
          COMMITS=$(git log --since="24 hours ago" --oneline | wc -l)
          if [ "$COMMITS" -gt "0" ]; then
            echo "has-commits=true" >> $GITHUB_OUTPUT
            echo "Found $COMMITS commit(s) on main in the last 24 hours"
          else
            echo "has-commits=false" >> $GITHUB_OUTPUT
            echo "No commits on main in the last 24 hours, skipping analysis"
          fi

  analyze:
    name: Run CodeCharta Analysis
    runs-on: ubuntu-latest
    needs: check-commits
    if: needs.check-commits.outputs.has-commits == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Fetch all branches
        run: git fetch --all

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup analysis branch
        run: |
          # Check if analysis branch exists remotely
          if git ls-remote --exit-code --heads origin analysis >/dev/null 2>&1; then
            echo "Analysis branch exists remotely, checking it out"
            git checkout -b analysis origin/analysis 2>/dev/null || git checkout analysis
          else
            echo "Analysis branch does not exist, creating it from main"
            git checkout -b analysis
            # Create docs directory and README
            mkdir -p docs
            echo "# CodeCharta Analysis Results" > docs/README.md
            git add docs/README.md
            git commit -m "chore: initialize analysis branch [skip ci]" || true
            git push -u origin analysis
          fi

      - name: Checkout main for analysis
        run: |
          git checkout main
          git pull origin main || true

      - name: Generate date variable
        run: echo "DATE=$(date +%m_%d_%y)" >> $GITHUB_ENV

      - name: Run CodeCharta Analysis
        run: |
          CONTAINER_NAME="codecharta-$$"
          docker run --name $CONTAINER_NAME \
            -v ${{ github.workspace }}:/mnt/src \
            codecharta/codecharta-analysis \
            bash -c "git config --global --add safe.directory /mnt/src && cd /mnt/src && ccsh unifiedparser -o=/tmp/cc_metrics_${{ env.DATE }} ."
          docker cp $CONTAINER_NAME:/tmp/cc_metrics_${{ env.DATE }}.cc.json.gz ./cc_metrics_${{ env.DATE }}.cc.json.gz
          docker rm $CONTAINER_NAME

      - name: Switch to analysis branch and commit results
        run: |
          git checkout analysis
          mkdir -p docs
          gunzip -c cc_metrics_${{ env.DATE }}.cc.json.gz > docs/cc_metrics_${{ env.DATE }}.cc.json
          rm cc_metrics_${{ env.DATE }}.cc.json.gz
          
          git add docs/cc_metrics_${{ env.DATE }}.cc.json
          git diff --staged --quiet || git commit -m "chore: update CodeCharta analysis [skip ci]"
          git push origin HEAD:analysis

      - name: Upload analysis file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecharta-analysis
          path: docs/cc_metrics_${{ env.DATE }}.cc.json
          retention-days: 30

      - name: Generate visualization link
        run: |
          {
            echo "CodeCharta analysis completed successfully!"
            echo ""
            echo "### Visualization Links"
            echo ""
            echo "- **Analysis file**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/cc_metrics_${{ env.DATE }}.cc.json"
            echo "- **CodeCharta Web Studio**: https://codecharta.com/web/?file=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/cc_metrics_${{ env.DATE }}.cc.json"
            echo ""
            echo "> **Note**: GitHub Pages must be configured in repository settings to use the \`analysis\` branch as the source. The analysis branch contains only the \`docs/\` directory with analysis results."
          } >> $GITHUB_STEP_SUMMARY

